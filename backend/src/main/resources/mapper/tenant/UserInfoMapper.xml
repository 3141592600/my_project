<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.work.mapper.tenant.UserInfoMapper">

    <!-- 动态更新用户信息 -->
    <update id="updateUserInfo" parameterType="com.example.work.entity.tenant.UserInfo">
        UPDATE user_info
        <set>
            <if test="userInfo.real_name != null">real_name = #{userInfo.real_name},</if>
            <if test="userInfo.phone != null">phone = #{userInfo.phone},</if>
            <if test="userInfo.email != null">email = #{userInfo.email},</if>
            update_time = NOW()
        </set>
        WHERE username = #{username}
    </update>

    <update id="createTable_user_field_permission" >
        CREATE TABLE IF NOT EXISTS user_field_permission (
            id BIGINT AUTO_INCREMENT PRIMARY KEY,
            table_name VARCHAR(64) NOT NULL,
            username VARCHAR(64) NOT NULL,
            field_permissions TEXT NOT NULL,
            create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    </update>

    <select id="checkTableExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM information_schema.tables
        WHERE table_schema = DATABASE()
          AND table_name = '${tableName}'
    </select>

    <!-- 查询指定表的所有字段名 -->
    <select id="getAllFieldNamesFromTable" resultType="string">
        SELECT COLUMN_NAME
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = #{tableName}
    </select>

</mapper>